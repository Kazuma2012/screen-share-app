<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç”»é¢å…±æœ‰ã‚¢ãƒ—ãƒªï¼ˆæ”¹è‰¯ç‰ˆï¼‰</title>
<style>
body { font-family: Arial; text-align: center; margin:0; padding:0; background:#f5f5f5; }
.container { padding:20px; }
button { padding:10px 20px; margin:10px; font-size:16px; cursor:pointer; }
.hidden { display:none; }
input[type="text"] { padding:8px; font-size:16px; width:150px; text-align:center; }
video { border:1px solid #ccc; width:80%; max-width:600px; margin-top:10px; background:black; }
#shareStatus, #receiveStatus { font-weight: bold; }
</style>
</head>
<body>

<!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
<div class="container" id="homePage">
  <h1>ç”»é¢å…±æœ‰ã‚¢ãƒ—ãƒª</h1>
  <button id="shareBtn">å…±æœ‰</button>
  <button id="addBtn">è¿½åŠ </button>
</div>

<!-- å…±æœ‰å´ç”»é¢ -->
<div class="container hidden" id="sharePage">
  <h2>å…±æœ‰ç”»é¢</h2>
  <p>ã‚ãªãŸã®å…±æœ‰ã‚³ãƒ¼ãƒ‰: <span id="shareCode">000000</span></p>
  <p>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="shareStatus" style="color:red;">æœªå…±æœ‰</span></p>
  <button id="setScreenBtn">ç”»é¢ã‚’ã‚»ãƒƒãƒˆ</button>

  <div class="preview hidden" id="screenPreview">
    <p>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
    <video id="previewVideo" autoplay playsinline></video><br>
    <button id="startShareBtn">ã“ã®ç”»é¢ã‚’å…±æœ‰ã—ã¾ã™ã‹ï¼Ÿ</button>
    <button id="reselectBtn">ã‚‚ã†ä¸€åº¦é¸æŠ</button>
  </div>

  <button id="backToHome1">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
</div>

<!-- å—ä¿¡å´ç”»é¢ -->
<div class="container hidden" id="addPage">
  <h2>ç”»é¢ã‚’è¿½åŠ </h2>
  <p>å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:</p>
  <input type="text" id="inputCode" maxlength="6" placeholder="123456">
  <button id="connectBtn">æ¥ç¶š</button>
  <p>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="receiveStatus" style="color:red;">æœªæ¥ç¶š</span></p>

  <div class="preview" id="receivedScreen"> <!-- â† hiddenå‰Šé™¤ -->
    <p>å…±æœ‰ç”»é¢è¡¨ç¤º</p>
    <video id="receivedVideo" autoplay playsinline></video> <!-- â† playsinlineè¿½åŠ  -->
  </div>

  <button id="backToHome2">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
</div>

<script>
const homePage = document.getElementById('homePage');
const sharePage = document.getElementById('sharePage');
const addPage = document.getElementById('addPage');
const screenPreview = document.getElementById('screenPreview');
const receivedScreen = document.getElementById('receivedScreen');
const previewVideo = document.getElementById('previewVideo');
const receivedVideo = document.getElementById('receivedVideo');
const shareCodeSpan = document.getElementById('shareCode');
const shareStatus = document.getElementById('shareStatus');
const receiveStatus = document.getElementById('receiveStatus');

let localStream = null;
let pc = null;
let ws = null;

// ãƒšãƒ¼ã‚¸åˆ‡æ›¿
document.getElementById('shareBtn').addEventListener('click', () => {
  homePage.classList.add('hidden');
  sharePage.classList.remove('hidden');
});
document.getElementById('addBtn').addEventListener('click', () => {
  homePage.classList.add('hidden');
  addPage.classList.remove('hidden');
});
document.getElementById('backToHome1').addEventListener('click', () => {
  shareStatus.textContent = 'æœªå…±æœ‰';
  shareStatus.style.color = 'red';
  sharePage.classList.add('hidden');
  homePage.classList.remove('hidden');
  screenPreview.classList.add('hidden');
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  if(pc) pc.close();
  if(ws) ws.close();
});
document.getElementById('backToHome2').addEventListener('click', () => {
  receiveStatus.textContent = 'æœªæ¥ç¶š';
  receiveStatus.style.color = 'red';
  addPage.classList.add('hidden');
  homePage.classList.remove('hidden');
  if(pc) pc.close();
  if(ws) ws.close();
});

// 6æ¡ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
function generateCode() {
  return Math.floor(100000 + Math.random() * 900000);
}

// ç”»é¢ã‚»ãƒƒãƒˆ
document.getElementById('setScreenBtn').addEventListener('click', async () => {
  shareCodeSpan.textContent = generateCode();
  try {
    localStream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:false });
    previewVideo.srcObject = localStream;
    screenPreview.classList.remove('hidden');
  } catch(e) {
    console.log('ç”»é¢å–å¾—å¤±æ•—:', e);
    alert('ç”»é¢å…±æœ‰ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
  }
});

// ã‚‚ã†ä¸€åº¦é¸æŠ
document.getElementById('reselectBtn').addEventListener('click', async () => {
  shareStatus.textContent = 'æœªå…±æœ‰';
  shareStatus.style.color = 'red';
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  screenPreview.classList.add('hidden');
});

// å®‰å…¨ã«WebSocketé€ä¿¡
function safeSend(msg) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(msg));
  } else {
    ws?.addEventListener('open', () => {
      try { ws.send(JSON.stringify(msg)); } catch(e) { console.log('sendå¤±æ•—:', e); }
    }, { once:true });
  }
}

// WebRTCåˆæœŸåŒ–
async function initWebRTC(code, isSender) {
  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  try {
    ws = new WebSocket(`${protocol}//${location.host}`);
  } catch(e) {
    console.log('WebSocketä½œæˆå¤±æ•—:', e);
    return;
  }

  pc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });

  if(isSender && localStream) {
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  }

  pc.onicecandidate = e => { if(e.candidate) safeSend({ type:'ice', code, payload:e.candidate }); };

  pc.ontrack = e => {
    console.log('ğŸ“º å—ä¿¡ã‚¹ãƒˆãƒªãƒ¼ãƒ åˆ°ç€');
    receivedVideo.srcObject = e.streams[0];
    receivedScreen.classList.remove('hidden');
    receivedVideo.play().catch(err => console.log('ğŸ¬ å†ç”Ÿã‚¨ãƒ©ãƒ¼:', err));
  };

  ws.onopen = () => safeSend({ type:'join', code });

  ws.onmessage = async (msg) => {
    try {
      const data = JSON.parse(msg.data);
      if(data.type === 'offer' && !isSender) {
        console.log('ğŸ“© offer å—ä¿¡');
        await pc.setRemoteDescription(data.payload);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        safeSend({ type:'answer', code, payload:answer });
      } else if(data.type === 'answer' && isSender) {
        console.log('ğŸ“¨ answer å—ä¿¡');
        await pc.setRemoteDescription(data.payload);
      } else if(data.type === 'ice') {
        await pc.addIceCandidate(data.payload);
      }
    } catch(e) {
      console.log('WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†å¤±æ•—:', e);
    }
  };

  ws.onerror = e => console.log('WebSocketã‚¨ãƒ©ãƒ¼:', e);
  ws.onclose = e => console.log('WebSocketé–‰ã˜ã¾ã—ãŸ');
}

// å…±æœ‰é–‹å§‹ï¼ˆé€ä¿¡å´ï¼‰
document.getElementById('startShareBtn').addEventListener('click', async () => {
  await initWebRTC(shareCodeSpan.textContent, true);
  shareStatus.textContent = 'å…±æœ‰ä¸­';
  shareStatus.style.color = 'green';

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  safeSend({ type: 'offer', code: shareCodeSpan.textContent, payload: offer });
});

// æ¥ç¶šãƒœã‚¿ãƒ³ï¼ˆå—ä¿¡å´ï¼‰
document.getElementById('connectBtn').addEventListener('click', async () => {
  const code = document.getElementById('inputCode').value.trim();
  if (!code) return alert('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  await initWebRTC(code, false);
  receiveStatus.textContent = 'æ¥ç¶šä¸­';
  receiveStatus.style.color = 'green';
});
</script>
</body>
</html>
