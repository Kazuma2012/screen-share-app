<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>画面共有アプリ（改良版）</title>
<style>
body { font-family: Arial; text-align: center; margin:0; padding:0; background:#f5f5f5; }
.container { padding:20px; }
button { padding:10px 20px; margin:10px; font-size:16px; cursor:pointer; }
.hidden { display:none; }
input[type="text"] { padding:8px; font-size:16px; width:150px; text-align:center; }
video { border:1px solid #ccc; width:80%; max-width:600px; margin-top:10px; background:black; }
#shareStatus, #receiveStatus { font-weight: bold; }
</style>
</head>
<body>

<!-- ホーム画面 -->
<div class="container" id="homePage">
  <h1>画面共有アプリ</h1>
  <button id="shareBtn">共有</button>
  <button id="addBtn">追加</button>
</div>

<!-- 共有側画面 -->
<div class="container hidden" id="sharePage">
  <h2>共有画面</h2>
  <p>あなたの共有コード: <span id="shareCode">000000</span></p>
  <p>ステータス: <span id="shareStatus" style="color:red;">未共有</span></p>
  <button id="setScreenBtn">画面をセット</button>

  <div class="preview hidden" id="screenPreview">
    <p>プレビュー</p>
    <video id="previewVideo" autoplay playsinline></video><br>
    <button id="startShareBtn">この画面を共有しますか？</button>
    <button id="reselectBtn">もう一度選択</button>
  </div>

  <button id="backToHome1">ホームに戻る</button>
</div>

<!-- 受信側画面 -->
<div class="container hidden" id="addPage">
  <h2>画面を追加</h2>
  <p>共有コードを入力してください:</p>
  <input type="text" id="inputCode" maxlength="6" placeholder="123456">
  <button id="connectBtn">接続</button>
  <p>ステータス: <span id="receiveStatus" style="color:red;">未接続</span></p>

  <div class="preview" id="receivedScreen"> <!-- ← hidden削除 -->
    <p>共有画面表示</p>
    <video id="receivedVideo" autoplay playsinline></video> <!-- ← playsinline追加 -->
  </div>

  <button id="backToHome2">ホームに戻る</button>
</div>

<script>
const homePage = document.getElementById('homePage');
const sharePage = document.getElementById('sharePage');
const addPage = document.getElementById('addPage');
const screenPreview = document.getElementById('screenPreview');
const receivedScreen = document.getElementById('receivedScreen');
const previewVideo = document.getElementById('previewVideo');
const receivedVideo = document.getElementById('receivedVideo');
const shareCodeSpan = document.getElementById('shareCode');
const shareStatus = document.getElementById('shareStatus');
const receiveStatus = document.getElementById('receiveStatus');

let localStream = null;
let pc = null;
let ws = null;

// ページ切替
document.getElementById('shareBtn').addEventListener('click', () => {
  homePage.classList.add('hidden');
  sharePage.classList.remove('hidden');
});
document.getElementById('addBtn').addEventListener('click', () => {
  homePage.classList.add('hidden');
  addPage.classList.remove('hidden');
});
document.getElementById('backToHome1').addEventListener('click', () => {
  shareStatus.textContent = '未共有';
  shareStatus.style.color = 'red';
  sharePage.classList.add('hidden');
  homePage.classList.remove('hidden');
  screenPreview.classList.add('hidden');
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  if(pc) pc.close();
  if(ws) ws.close();
});
document.getElementById('backToHome2').addEventListener('click', () => {
  receiveStatus.textContent = '未接続';
  receiveStatus.style.color = 'red';
  addPage.classList.add('hidden');
  homePage.classList.remove('hidden');
  if(pc) pc.close();
  if(ws) ws.close();
});

// 6桁コード生成
function generateCode() {
  return Math.floor(100000 + Math.random() * 900000);
}

// 画面セット
document.getElementById('setScreenBtn').addEventListener('click', async () => {
  shareCodeSpan.textContent = generateCode();
  try {
    localStream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:false });
    previewVideo.srcObject = localStream;
    screenPreview.classList.remove('hidden');
  } catch(e) {
    console.log('画面取得失敗:', e);
    alert('画面共有が許可されませんでした');
  }
});

// もう一度選択
document.getElementById('reselectBtn').addEventListener('click', async () => {
  shareStatus.textContent = '未共有';
  shareStatus.style.color = 'red';
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  screenPreview.classList.add('hidden');
});

// 安全にWebSocket送信
function safeSend(msg) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(msg));
  } else {
    ws?.addEventListener('open', () => {
      try { ws.send(JSON.stringify(msg)); } catch(e) { console.log('send失敗:', e); }
    }, { once:true });
  }
}

// WebRTC初期化
async function initWebRTC(code, isSender) {
  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  try {
    ws = new WebSocket(`${protocol}//${location.host}`);
  } catch(e) {
    console.log('WebSocket作成失敗:', e);
    return;
  }

  pc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });

  if(isSender && localStream) {
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  }

  pc.onicecandidate = e => { if(e.candidate) safeSend({ type:'ice', code, payload:e.candidate }); };

  pc.ontrack = e => {
    console.log('📺 受信ストリーム到着');
    receivedVideo.srcObject = e.streams[0];
    receivedScreen.classList.remove('hidden');
    receivedVideo.play().catch(err => console.log('🎬 再生エラー:', err));
  };

  ws.onopen = () => safeSend({ type:'join', code });

  ws.onmessage = async (msg) => {
    try {
      const data = JSON.parse(msg.data);
      if(data.type === 'offer' && !isSender) {
        console.log('📩 offer 受信');
        await pc.setRemoteDescription(data.payload);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        safeSend({ type:'answer', code, payload:answer });
      } else if(data.type === 'answer' && isSender) {
        console.log('📨 answer 受信');
        await pc.setRemoteDescription(data.payload);
      } else if(data.type === 'ice') {
        await pc.addIceCandidate(data.payload);
      }
    } catch(e) {
      console.log('WebSocketメッセージ処理失敗:', e);
    }
  };

  ws.onerror = e => console.log('WebSocketエラー:', e);
  ws.onclose = e => console.log('WebSocket閉じました');
}

// 共有開始（送信側）
document.getElementById('startShareBtn').addEventListener('click', async () => {
  await initWebRTC(shareCodeSpan.textContent, true);
  shareStatus.textContent = '共有中';
  shareStatus.style.color = 'green';

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  safeSend({ type: 'offer', code: shareCodeSpan.textContent, payload: offer });
});

// 接続ボタン（受信側）
document.getElementById('connectBtn').addEventListener('click', async () => {
  const code = document.getElementById('inputCode').value.trim();
  if (!code) return alert('コードを入力してください');
  await initWebRTC(code, false);
  receiveStatus.textContent = '接続中';
  receiveStatus.style.color = 'green';
});
</script>
</body>
</html>
