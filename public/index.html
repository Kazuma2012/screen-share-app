<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç°¡æ˜“ ç”»é¢å…±æœ‰ã‚¢ãƒ—ãƒª (Single-file)</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding:20px; }
  .hidden { display:none; }
  .center { display:flex; gap:10px; align-items:center; }
  button { padding:10px 14px; font-size:16px; cursor:pointer; }
  input { padding:8px; font-size:16px; }
  #preview { width:640px; max-width:100%; border:1px solid #ccc; background:#000; }
  .box { margin-top:16px; padding:12px; border:1px solid #eee; border-radius:8px; }
  .muted { color:#666; font-size:14px; }
  small { color:#666; display:block; margin-top:6px; }
</style>
</head>
<body>

<h1>ç”»é¢å…±æœ‰ã‚¢ãƒ—ãƒª</h1>
<p class="muted">ã¯ã˜ã‚ã«ã€Œå…±æœ‰ã€ã‹ã€Œè¿½åŠ ã€ã‚’é¸ã¶ã€‚6æ¡ã‚³ãƒ¼ãƒ‰ã§ãƒãƒƒãƒãƒ³ã‚°ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«æ§‹æˆã€‚</p>

<div id="home" class="box">
  <div class="center">
    <button id="shareBtn">å…±æœ‰</button>
    <button id="addBtn">è¿½åŠ </button>
  </div>
</div>

<div id="sharePage" class="box hidden">
  <div>ç”Ÿæˆã‚³ãƒ¼ãƒ‰: <strong id="roomCode">------</strong></div>
  <small class="muted">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ç”»é¢ã‚’è¦‹ã‚‹å´ã«æ•™ãˆã‚‹ï¼ˆæ•°å­—6æ¡ï¼‰</small>
  <div style="margin-top:12px;">
    <button id="setScreenBtn">ç”»é¢ã‚’ã‚»ãƒƒãƒˆ</button>
    <button id="backFromShare">æˆ»ã‚‹</button>
  </div>

  <div id="previewArea" class="hidden" style="margin-top:12px">
    <video id="preview" autoplay playsinline muted></video>
    <div style="margin-top:8px;">
      <button id="confirmShareBtn">ã“ã®ç”»é¢ã‚’å…±æœ‰</button>
      <button id="reselectBtn">ã‚‚ã†ä¸€åº¦é¸æŠ</button>
    </div>
  </div>

  <div id="shareStatus" class="muted" style="margin-top:10px"></div>
</div>

<div id="addPage" class="box hidden">
  <div>å…±æœ‰ã‚³ãƒ¼ãƒ‰å…¥åŠ›</div>
  <div style="margin-top:8px;">
    <input id="joinCodeInput" placeholder="ä¾‹ï¼š123456" maxlength="6" />
    <button id="joinBtn">æ¥ç¶š</button>
    <button id="backFromAdd">æˆ»ã‚‹</button>
  </div>
  <div id="receiveArea" class="hidden" style="margin-top:12px">
    <video id="remoteView" autoplay playsinline controls></video>
  </div>
  <div id="addStatus" class="muted" style="margin-top:10px"></div>
</div>

<hr />
<div class="muted small">æŠ€è¡“ãƒ¡ãƒ¢ï¼šWebRTC + WebSocket ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚’ä½¿ç”¨ã€‚ã‚µãƒ¼ãƒã¯åŒä¸€ Node ãƒ—ãƒ­ã‚»ã‚¹ã§æä¾›ã€‚</div>

<script>
/*
  ãƒ•ãƒ­ãƒ³ãƒˆä¸€å¼ã€‚æ³¨æ„: ã‚·ã‚°ãƒŠãƒªãƒ³ã‚° URL ã¯è‡ªå‹•è¨ˆç®—ã™ã‚‹ãŸã‚ã€Render ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚‚è¨­å®šä¸è¦ã€‚
*/

// auto-detect signaling URL
const SIGNALING_SERVER_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host;

// UI è¦ç´ 
const shareBtn = document.getElementById('shareBtn');
const addBtn = document.getElementById('addBtn');
const home = document.getElementById('home');

const sharePage = document.getElementById('sharePage');
const addPage = document.getElementById('addPage');

const roomCodeEl = document.getElementById('roomCode');
const setScreenBtn = document.getElementById('setScreenBtn');
const backFromShare = document.getElementById('backFromShare');

const previewArea = document.getElementById('previewArea');
const previewVideo = document.getElementById('preview');
const confirmShareBtn = document.getElementById('confirmShareBtn');
const reselectBtn = document.getElementById('reselectBtn');
const shareStatus = document.getElementById('shareStatus');

const joinCodeInput = document.getElementById('joinCodeInput');
const joinBtn = document.getElementById('joinBtn');
const backFromAdd = document.getElementById('backFromAdd');
const receiveArea = document.getElementById('receiveArea');
const remoteView = document.getElementById('remoteView');
const addStatus = document.getElementById('addStatus');

let ws = null;
let role = null;
let roomCode = null;
let localStream = null;
let pc = null;
let dataChannel = null;

const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

function gen6Code(){ return Math.floor(Math.random() * 1000000).toString().padStart(6,'0'); }
function showHome(){ home.classList.remove('hidden'); sharePage.classList.add('hidden'); addPage.classList.add('hidden'); }
function showSharePage(){ home.classList.add('hidden'); sharePage.classList.remove('hidden'); addPage.classList.add('hidden'); }
function showAddPage(){ home.classList.add('hidden'); sharePage.classList.add('hidden'); addPage.classList.remove('hidden'); }

function ensureWS(){
  if (ws && ws.readyState === WebSocket.OPEN) return;
  ws = new WebSocket(SIGNALING_SERVER_URL);
  ws.addEventListener('message', (ev)=> {
    let msg;
    try { msg = JSON.parse(ev.data); } catch(e){ return; }
    handleSignalingMessage(msg);
  });
  ws.addEventListener('close', ()=> { appendStatus('ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°æ¥ç¶šãŒåˆ‡æ–­ã•ã‚ŒãŸ'); });
  ws.addEventListener('error', ()=> { appendStatus('ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ'); });
}

function sendSignaling(obj){
  if (!ws || ws.readyState !== WebSocket.OPEN){ appendStatus('ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°æœªæ¥ç¶šã€‚'); return; }
  ws.send(JSON.stringify(obj));
}

async function handleSignalingMessage(msg){
  if (msg.type === 'offer' && role === 'viewer'){
    await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    sendSignaling({ action:'answer', code: roomCode, sdp: pc.localDescription });
    appendStatus('answer é€ä¿¡ã—ãŸã€‚');
  } else if (msg.type === 'answer' && role === 'sharer'){
    await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
    appendStatus('ç›¸æ‰‹ãŒæ¥ç¶šã—ãŸã€‚å…±æœ‰é–‹å§‹ã€‚ğŸ‰');
  } else if (msg.type === 'ice-candidate'){
    try { await pc.addIceCandidate(msg.candidate); } catch(e){}
  } else if (msg.type === 'peer-joined' && role === 'sharer'){
    appendStatus('èª°ã‹ãŒæ¥ç¶šã—ãŸã€‚offer ã‚’é€ã‚‹æº–å‚™ã‚’ç¶šã‘ã‚‹ã€‚');
  } else if (msg.type === 'error'){
    appendStatus('ã‚¨ãƒ©ãƒ¼: ' + (msg.reason || 'ä¸æ˜'));
  }
}

function appendStatus(text){
  if (role === 'sharer') shareStatus.textContent = text || '';
  if (role === 'viewer') addStatus.textContent = text || '';
}

// --- å…±æœ‰è€… ---
shareBtn.addEventListener('click', ()=>{
  role = 'sharer';
  roomCode = gen6Code();
  roomCodeEl.textContent = roomCode;
  showSharePage();
  appendStatus('ã‚³ãƒ¼ãƒ‰ç™ºè¡Œæ¸ˆã¿ã€‚æ¬¡ã«ã€Œç”»é¢ã‚’ã‚»ãƒƒãƒˆã€ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã—ã¦ã€‚');
  ensureWS();
  setTimeout(()=> { 
    if (ws && ws.readyState === WebSocket.OPEN) sendSignaling({ action: 'create', code: roomCode }); 
    else ws.addEventListener('open', ()=> sendSignaling({ action:'create', code: roomCode }), { once: true });
  }, 200);
});

setScreenBtn.addEventListener('click', async ()=>{
  try {
    localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
    previewVideo.srcObject = localStream;
    previewArea.classList.remove('hidden');
    appendStatus('ç”»é¢é¸æŠå®Œäº†ã€‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚');
  } catch(e){
    appendStatus('ç”»é¢é¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã€‚');
  }
});

reselectBtn.addEventListener('click', async ()=>{
  if (localStream) localStream.getTracks().forEach(t=>t.stop());
  localStream = null;
  previewArea.classList.add('hidden');
  appendStatus('å†é¸æŠã—ã¦ã€‚');
});

confirmShareBtn.addEventListener('click', async ()=>{
  if (!localStream){ appendStatus('ã¾ãšç”»é¢ã‚’ã‚»ãƒƒãƒˆã—ã¦ã€‚'); return; }
  appendStatus('å…±æœ‰ã‚’é–‹å§‹ã™ã‚‹ã€‚ç›¸æ‰‹ãŒã‚³ãƒ¼ãƒ‰ã§æ¥ç¶šã™ã‚‹ã¾ã§å¾…æ©Ÿã€‚');
  pc = new RTCPeerConnection(rtcConfig);
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  pc.addEventListener('icecandidate', (ev)=> { if (ev.candidate) sendSignaling({ action:'ice-candidate', code: roomCode, candidate: ev.candidate }); });
  dataChannel = pc.createDataChannel('chat');
  dataChannel.onopen = ()=> console.log('data channel open');
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ensureWS();
  if (ws.readyState === WebSocket.OPEN) sendSignaling({ action:'offer', code: roomCode, sdp: pc.localDescription });
  else ws.addEventListener('open', ()=> sendSignaling({ action:'offer', code: roomCode, sdp: pc.localDescription }), { once: true });
  appendStatus('offer é€ä¿¡ã—ãŸã€‚ç›¸æ‰‹ã® answer ã‚’å¾…ã¤ã€‚');
});

backFromShare.addEventListener('click', ()=>{
  if (localStream) localStream.getTracks().forEach(t=>t.stop());
  if (pc) pc.close();
  pc = null; localStream = null; role = null;
  showHome(); appendStatus('');
});

// --- è¦–è´è€… ---
addBtn.addEventListener('click', ()=>{
  role = 'viewer';
  showAddPage();
  appendStatus('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦æ¥ç¶šã—ã¦ã€‚');
  ensureWS();
});

joinBtn.addEventListener('click', async ()=>{
  const code = (joinCodeInput.value || '').trim();
  if (!/^\d{6}$/.test(code)){ appendStatus('6æ¡ã®æ•°å­—ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã€‚'); return; }
  roomCode = code;
  appendStatus('æ¥ç¶šå‡¦ç†ã‚’é–‹å§‹ã™ã‚‹ã€‚');

  pc = new RTCPeerConnection(rtcConfig);
  pc.addEventListener('track', (ev)=>{
    const [stream] = ev.streams;
    remoteView.srcObject = stream;
    receiveArea.classList.remove('hidden');
    appendStatus('ç”»é¢ã‚’å—ä¿¡ä¸­ã€‚');
  });
  pc.addEventListener('icecandidate', (ev)=> { if (ev.candidate) sendSignaling({ action:'ice-candidate', code: roomCode, candidate: ev.candidate }); });
  pc.ondatachannel = (ev)=> { const ch = ev.channel; ch.onmessage = (e)=> console.log('dc recv', e.data); };

  ensureWS();

  // âœ… WebSocketãŒopenã«ãªã‚‹ã¾ã§å¾…ã£ã¦ã‹ã‚‰joiné€ä¿¡
  if (ws.readyState === WebSocket.OPEN) {
    sendSignaling({ action:'join', code: roomCode });
  } else {
    ws.addEventListener('open', ()=> sendSignaling({ action:'join', code: roomCode }), { once: true });
  }

  appendStatus('join è¦æ±‚ã‚’é€ä¿¡ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã¤ã€‚');
});

backFromAdd.addEventListener('click', ()=>{
  if (pc) pc.close();
  pc = null; role = null; roomCode = null;
  receiveArea.classList.add('hidden'); remoteView.srcObject = null; joinCodeInput.value = '';
  showHome(); appendStatus('');
});

appendStatus('åˆæœŸçŠ¶æ…‹ã€‚å…±æœ‰ã‹è¿½åŠ ã‚’é¸æŠã—ã¦ã€‚');
</script>
</body>
</html>
